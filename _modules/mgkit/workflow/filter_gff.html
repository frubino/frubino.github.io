

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mgkit.workflow.filter_gff &mdash; MGKit: Metagenomic framework 0.5.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> MGKit: Metagenomic framework
          

          
          </a>

          
            
            
              <div class="version">
                0.5.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline/index.html">Metagenomic Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gff.html">MGKit GFF Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">Library Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes.html">Changes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MGKit: Metagenomic framework</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../mgkit.html">mgkit</a> &raquo;</li>
        
      <li>mgkit.workflow.filter_gff</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mgkit.workflow.filter_gff</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Filters GFF annotations in different ways.</span>

<span class="sd">Value Filtering</span>
<span class="sd">***************</span>

<span class="sd">Enables filtering of GFF annotations based on the the values of attributes of a</span>
<span class="sd">GFF annotation. The filters are based on equality of numbers (internally</span>
<span class="sd">converted into float) and strings, a string contained in the value of an attribute</span>
<span class="sd">less or greater than are included as well. The length of annotation has the</span>
<span class="sd">attribute *length* and can be tested.</span>

<span class="sd">Overlap Filtering</span>
<span class="sd">*****************</span>

<span class="sd">Filters overlapping annotations using the functions</span>
<span class="sd">:func:`mgkit.filter.gff.choose_annotation` and</span>
<span class="sd">:func:`mgkit.filter.gff.filter_annotations`, after the annotations are grouped</span>
<span class="sd">by both sequence and strand. If the GFF is sorted by sequence name and strand,</span>
<span class="sd">the `-t` can be used to make the filtering use less memory. It can be sorted in</span>
<span class="sd">Unix using `sort -s -k 1,1 -k 7,7 gff_file`, which applies a stable sort using</span>
<span class="sd">the sequence name as the first key and the strand as the second key.</span>

<span class="sd">.. note::</span>

<span class="sd">    It is also recommended to use::</span>

<span class="sd">        export LC_ALL=C</span>

<span class="sd">    To speed up the sorting</span>

<span class="sd">.. blockdiag::</span>

<span class="sd">    {</span>
<span class="sd">        orientation = portrait;</span>

<span class="sd">        class mgkit [color = &quot;#e41a1c&quot; , textcolor = &#39;white&#39;, width=200,</span>
<span class="sd">        fontsize=15];</span>
<span class="sd">        class data [color = &quot;#4daf4a&quot; , textcolor = &#39;white&#39;, width=200,</span>
<span class="sd">        fontsize=15];</span>
<span class="sd">        class software [color = &quot;#377eb8&quot;, textcolor = &quot;white&quot;, fontsize=15];</span>

<span class="sd">        sort [class = software];</span>
<span class="sd">        &quot;GFF&quot; [class = data, shape = flowchart.input];</span>
<span class="sd">        parse_gff [class = &quot;mgkit&quot;];</span>
<span class="sd">        group_annotations [class = &quot;mgkit&quot;];</span>
<span class="sd">        filter_annotations [class = &quot;mgkit&quot;, shape = flowchart.condition,</span>
<span class="sd">        fontsize=12];</span>

<span class="sd">        &quot;GFF&quot; -&gt; parse_gff -&gt; sort -&gt; filter_annotations;</span>
<span class="sd">        parse_gff -&gt; group_annotations -&gt; filter_annotations;</span>

<span class="sd">        &quot;Filtered Annotations&quot; [class = data, stacked];</span>
<span class="sd">        filter_annotations -&gt; &quot;Filtered Annotations&quot;;</span>
<span class="sd">    }</span>

<span class="sd">The above digram describes the internals of the script.</span>

<span class="sd">The annotations needs first to be grouped by seq_id and strand, forming a group</span>
<span class="sd">that can be then be passed to :func:`mgkit.filter.gff.filter_annotations`.</span>
<span class="sd">This function:</span>

<span class="sd">    #. sort annotations by bit score, from the highest to the lowest</span>
<span class="sd">    #. loop over all combination of N=2 annotations:</span>

<span class="sd">        #. choose which of the two annotations to discard if they overlap for a</span>
<span class="sd">           the required amount of bp (defaults to 100bp)</span>
<span class="sd">        #. in which case, the preference is given to the db quality first, than</span>
<span class="sd">           the bit score and finally the lenght of annotation, the one with the</span>
<span class="sd">           highest values is kept</span>

<span class="sd">While the default behaviour is the same, now it is posible to decided the</span>
<span class="sd">function used to discard one the two annotations. It is possible to use the</span>
<span class="sd">`-c` argument to pass a string that defines the function. The string passed must</span>
<span class="sd">start with or without a **+**. Using **+** translates into the builtin function</span>
<span class="sd">*max* while no **+** translates into *min* from the second character on, any</span>
<span class="sd">number of attributes can be used, separated by commas. The attributes, however,</span>
<span class="sd">must be one of the properties defined in :class:`mgkit.io.gff.Annotation`,</span>
<span class="sd">*bitscore* that returns the value converted in a *float*. Internally the</span>
<span class="sd">attributes are stored as strings, so for attributes that have no properties in</span>
<span class="sd">the class, such as *evalue*, the `float` builtin is applied.</span>

<span class="sd">The tuples built for both annotations are then passed to the comparison</span>
<span class="sd">function to be selected and the value returned by it is **discarded**. The</span>
<span class="sd">order of the elements in the string is important to define the priority</span>
<span class="sd">given to each element in the comparison and the leftmost one has the</span>
<span class="sd">highesst priority.</span>

<span class="sd">Examples of function strings:</span>

<span class="sd">* `-dbq,bitscore,length` becomes max((ann1.dbq, ann1.bitscore, ann1.length),</span>
<span class="sd">  (ann2.dbq, ann2.bitscore, ann2.length) - This is default and previously</span>
<span class="sd">  only choice</span>
<span class="sd">* `-bitscore,length,dbq` uses the same elements but gives lowest priority</span>
<span class="sd">  to *dbq*</span>
<span class="sd">* `+evalue`: will discard the annotation with the highest *evalue*</span>

<span class="sd">Per Sequence Values</span>
<span class="sd">*******************</span>

<span class="sd">The *sequence* command allows to filter on a per sequence basis, using</span>
<span class="sd">functions such as the median, quantile and mean on attributes like evalue,</span>
<span class="sd">bitscore and identity. The file can be passed as sorted already, saving memory</span>
<span class="sd">(like in the *overlap* command), but it&#39;s not needed to sort the file by strand,</span>
<span class="sd">only by the first column.</span>

<span class="sd">Coverage Filtering</span>
<span class="sd">******************</span>

<span class="sd">The *cov* command calculates the coverage of annotations as a measure of the</span>
<span class="sd">percentage of each reference sequence length. A minimum coverage percentage can</span>
<span class="sd">be used to keep the annotations of sequences that have a greater or equal</span>
<span class="sd">coverage than the specified one.</span>

<span class="sd">Changes</span>
<span class="sd">*******</span>

<span class="sd">.. versionadded:: 0.1.12</span>

<span class="sd">.. versionchanged:: 0.1.13</span>
<span class="sd">    added *--sorted* option</span>

<span class="sd">.. versionchanged:: 0.2.0</span>
<span class="sd">    changed option *-c* to accept a string to filter overlap</span>

<span class="sd">.. versionchanged:: 0.2.5</span>
<span class="sd">    added *sequence* command</span>

<span class="sd">.. versionchanged:: 0.2.6</span>
<span class="sd">    added *length* as attribute and *min*/*max*, and *ge* is the default</span>
<span class="sd">    comparison for command *sequence*, *--sort-attr* to *overlap*</span>

<span class="sd">.. versionchanged:: 0.3.1</span>
<span class="sd">    added *--num-gt* and *--num-lt* to *values* command, added *cov* command</span>

<span class="sd">.. versionchanged:: 0.3.4</span>
<span class="sd">    moved to use *click* for argument parsing reworked the *values*, *sequence*</span>
<span class="sd">    commands</span>

<span class="sd">.. versionchanged:: 0.4.4</span>
<span class="sd">    *overlap* command: added option to not use the strand information and</span>
<span class="sd">    added an option to make multiple passes of overlap for each sequence</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="n">viewvalues</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">mgkit</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">..io</span> <span class="kn">import</span> <span class="n">gff</span><span class="p">,</span> <span class="n">fasta</span>
<span class="kn">from</span> <span class="nn">..filter</span> <span class="kn">import</span> <span class="n">gff</span> <span class="k">as</span> <span class="n">filter_gff</span>
<span class="kn">from</span> <span class="nn">..utils.common</span> <span class="kn">import</span> <span class="n">ranges_length</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">version_option</span><span class="p">()</span>
<span class="nd">@utils</span><span class="o">.</span><span class="n">cite_option</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="s2">&quot;Main function&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="perseq_calc_threshold"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.perseq_calc_threshold">[docs]</a><span class="k">def</span> <span class="nf">perseq_calc_threshold</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">func_arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">annotation</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;quantile&#39;</span><span class="p">:</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">func_arg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">func_arg</span> <span class="o">*</span> <span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Threshold for contig </span><span class="si">%s</span><span class="s2"> found: </span><span class="si">%.2f</span><span class="s2">, using funcion </span><span class="si">%s</span><span class="s2"> and its &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;arg </span><span class="si">%.2f</span><span class="s2"> on </span><span class="si">%d</span><span class="s2"> ann.&quot;</span><span class="p">,</span>
        <span class="n">annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">thres</span><span class="p">,</span>
        <span class="n">function</span><span class="p">,</span>
        <span class="n">func_arg</span> <span class="k">if</span> <span class="n">function</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">thres</span></div>


<div class="viewcode-block" id="find_comparison"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.find_comparison">[docs]</a><span class="k">def</span> <span class="nf">find_comparison</span><span class="p">(</span><span class="n">comparison</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">comparison</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">comparison</span> <span class="o">==</span> <span class="s1">&#39;ge&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">comparison</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">comparison</span> <span class="o">==</span> <span class="s1">&#39;le&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span></div>


<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filter on a per sequence basis&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--sorted&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;If the GFF file is sorted (all of a sequence annotations</span>
<span class="s1">              are contiguos) can use less memory, `sort -s -k 1,1` can be used&#39;&#39;&#39;</span><span class="p">,)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--attribute&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;bitscore&#39;</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s1">&#39;evalue&#39;</span><span class="p">,</span> <span class="s1">&#39;bitscore&#39;</span><span class="p">,</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]),</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Attribute on which to apply the filter&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--function&#39;</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;quantile&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">]),</span>
              <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Function for filtering&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--value&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Value for the function (used for *std* and *quantile*)&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--comparison&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;ge&#39;</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="s1">&#39;ge&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="s1">&#39;le&#39;</span><span class="p">]),</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of comparison (e.g. ge -&gt; greater than or equal to)&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--progress&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shows Progress Bar&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;input-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;output-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">filter_perseq</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comparison</span><span class="p">,</span>
                  <span class="n">progress</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>

    <span class="n">mgkit</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">config_log</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;quantile&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">exit_script</span><span class="p">(</span><span class="s1">&#39;When *std* or *quantile* are used, --value must be passed&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">comparison</span> <span class="o">=</span> <span class="n">find_comparison</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Writing to file (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">file_iterator</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">parse_gff</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">gff_type</span><span class="o">=</span><span class="n">gff</span><span class="o">.</span><span class="n">from_gff</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">sorted</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input GFF is assumed sorted&quot;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">group_annotations_sorted</span><span class="p">(</span>
            <span class="n">file_iterator</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">seq_id</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">viewvalues</span><span class="p">(</span><span class="n">gff</span><span class="o">.</span><span class="n">group_annotations</span><span class="p">(</span>
            <span class="n">file_iterator</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">seq_id</span>
        <span class="p">))</span>

    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">annotations</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">perseq_calc_threshold</span><span class="p">(</span>
            <span class="n">annotations</span><span class="p">,</span>
            <span class="n">attribute</span><span class="p">,</span>
            <span class="n">function</span><span class="p">,</span>
            <span class="n">value</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comparison</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="n">threshold</span><span class="p">):</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>


<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filter on a per coverage basis&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--reference&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference FASTA file for the GFF&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--strand-specific&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If the coverage must be calculated on each strand&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--sorted&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Assumes the GFF to be correctly sorted&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--min-coverage&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum coverage for the contig/strand&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--rename&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Emulates BLAST in reading the FASTA file (keeps only the header before the first space)&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--progress&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shows Progress Bar&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;input-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;output-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">coverage_command</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">strand_specific</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">min_coverage</span><span class="p">,</span>
                     <span class="n">rename</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="n">mgkit</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">config_log</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Writing to file (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">file_iterator</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">parse_gff</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">gff_type</span><span class="o">=</span><span class="n">gff</span><span class="o">.</span><span class="n">from_gff</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strand_specific</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">key_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">seq_id</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">key_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">seq_id</span>

    <span class="k">if</span> <span class="nb">sorted</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input GFF is assumed sorted&quot;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">group_annotations_sorted</span><span class="p">(</span>
            <span class="n">file_iterator</span><span class="p">,</span> <span class="n">key_func</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">viewvalues</span><span class="p">(</span><span class="n">gff</span><span class="o">.</span><span class="n">group_annotations</span><span class="p">(</span>
            <span class="n">file_iterator</span><span class="p">,</span> <span class="n">key_func</span>
        <span class="p">))</span>

    <span class="n">seq_iter</span> <span class="o">=</span> <span class="n">fasta</span><span class="o">.</span><span class="n">load_fasta_rename</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span> <span class="k">if</span> <span class="n">rename</span> <span class="k">else</span> <span class="n">fasta</span><span class="o">.</span><span class="n">load_fasta</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>

    <span class="n">sequences</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">seq_id</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">seq_id</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">seq_iter</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">annotations</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">covered</span> <span class="o">=</span> <span class="n">ranges_length</span><span class="p">(</span>
            <span class="n">gff</span><span class="o">.</span><span class="n">elongate_annotations</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">sequences</span><span class="p">[</span><span class="n">annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seq_id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">covered</span> <span class="o">&lt;</span> <span class="n">min_coverage</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>


<div class="viewcode-block" id="filter_eq"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.filter_eq">[docs]</a><span class="k">def</span> <span class="nf">filter_eq</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ann_value</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gff</span><span class="o">.</span><span class="n">AttributeNotFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">ann_value</span> <span class="o">==</span> <span class="n">value</span></div>


<div class="viewcode-block" id="filter_in"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.filter_in">[docs]</a><span class="k">def</span> <span class="nf">filter_in</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ann_value</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gff</span><span class="o">.</span><span class="n">AttributeNotFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ann_value</span></div>


<div class="viewcode-block" id="filter_gt"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.filter_gt">[docs]</a><span class="k">def</span> <span class="nf">filter_gt</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ann_value</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gff</span><span class="o">.</span><span class="n">AttributeNotFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">equal</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ann_value</span> <span class="o">&gt;=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ann_value</span> <span class="o">&gt;</span> <span class="n">value</span></div>


<div class="viewcode-block" id="filter_lt"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.filter_lt">[docs]</a><span class="k">def</span> <span class="nf">filter_lt</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ann_value</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gff</span><span class="o">.</span><span class="n">AttributeNotFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">equal</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ann_value</span> <span class="o">&lt;=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ann_value</span> <span class="o">&lt;</span> <span class="n">value</span></div>


<div class="viewcode-block" id="setup_filters"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.setup_filters">[docs]</a><span class="k">def</span> <span class="nf">setup_filters</span><span class="p">(</span><span class="n">str_eq</span><span class="p">,</span> <span class="n">str_in</span><span class="p">,</span> <span class="n">num_eq</span><span class="p">,</span> <span class="n">num_ge</span><span class="p">,</span> <span class="n">num_le</span><span class="p">,</span> <span class="n">num_gt</span><span class="p">,</span> <span class="n">num_lt</span><span class="p">):</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">str_eq</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter string (</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_eq</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">str_in</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter string (</span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_in</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">num_eq</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter number (</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_eq</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">num_ge</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter number (</span><span class="si">%s</span><span class="s1"> &gt;= </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_gt</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">num_gt</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter number (</span><span class="si">%s</span><span class="s1"> &gt; </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_gt</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">num_le</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter number (</span><span class="si">%s</span><span class="s1"> &lt;= </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_lt</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">num_lt</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter number (</span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">filter_lt</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">filters</span></div>


<div class="viewcode-block" id="validate_params"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.validate_params">[docs]</a><span class="k">def</span> <span class="nf">validate_params</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
    <span class="n">new_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span>
                <span class="s2">&quot;Wrong key/value format, must be &#39;key:value&#39; &#39;key:value&#39;&quot;</span>
            <span class="p">)</span>
        <span class="n">new_values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">convert</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">new_values</span></div>


<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Filter based on values&quot;&quot;&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--str-eq&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;filter by custom key:value, if the argument is &#39;key:value&#39; the annotation is kept if it contains an attribute &#39;key&#39; whose value is exactly &#39;value&#39; as a string&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--str-in&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Same as &#39;--str-eq&#39; but &#39;value&#39; is contained in the attribute&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--num-eq&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Same as &#39;--str-eq&#39; but &#39;value&#39; is a number which is equal or greater than&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--num-ge&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Same as &#39;--str-eq&#39; but &#39;value&#39; is a number which is equal or greater than&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--num-le&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Same as &#39;--num-ge&#39; but &#39;value&#39; is a number which is equal or less than&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--num-gt&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Same as &#39;--str-eq&#39; but &#39;value&#39; is a number which is greater than&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--num-lt&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">callback</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">validate_params</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Same as &#39;--num-ge&#39; but &#39;value&#39; is a number which is less than&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--progress&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shows Progress Bar&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;input-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;output-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">filter_values</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">str_eq</span><span class="p">,</span> <span class="n">str_in</span><span class="p">,</span> <span class="n">num_eq</span><span class="p">,</span> <span class="n">num_ge</span><span class="p">,</span> <span class="n">num_le</span><span class="p">,</span> <span class="n">num_gt</span><span class="p">,</span> <span class="n">num_lt</span><span class="p">,</span>
                  <span class="n">progress</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="n">mgkit</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">config_log</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Writing to file (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">filters</span> <span class="o">=</span> <span class="n">setup_filters</span><span class="p">(</span><span class="n">str_eq</span><span class="p">,</span> <span class="n">str_in</span><span class="p">,</span> <span class="n">num_eq</span><span class="p">,</span> <span class="n">num_ge</span><span class="p">,</span> <span class="n">num_le</span><span class="p">,</span> <span class="n">num_gt</span><span class="p">,</span> <span class="n">num_lt</span><span class="p">)</span>

    <span class="n">iterator</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">parse_gff</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">gff_type</span><span class="o">=</span><span class="n">gff</span><span class="o">.</span><span class="n">from_gff</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">filter_func</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span> <span class="k">for</span> <span class="n">filter_func</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">):</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>


<div class="viewcode-block" id="make_choose_func"><a class="viewcode-back" href="../../../api/mgkit.workflow.filter_gff.html#mgkit.workflow.filter_gff.make_choose_func">[docs]</a><span class="k">def</span> <span class="nf">make_choose_func</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builds the function used to choose between two annotations.&quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filter function used for overlaps </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
        <span class="n">function</span> <span class="o">=</span> <span class="nb">max</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">function</span> <span class="o">=</span> <span class="nb">min</span>

    <span class="n">attributes</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">choose_func</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">function</span><span class="p">(</span>
            <span class="n">a1</span><span class="p">,</span>
            <span class="n">a2</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span> <span class="k">else</span> <span class="n">el</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">choose_func</span></div>


<span class="nd">@main</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;overlap&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use overlapping filter&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Size of the overlap that triggers the filter&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--sorted&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;If the GFF file is sorted (all of a sequence annotations are contiguos and sorted by strand) can use less memory, `sort -s -k 1,1 -k 7,7` can be used&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--choose-func&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;dbq,bitscore,length&#39;</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Function to choose between two overlapping annotations&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--sort-attr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;bitscore&#39;</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s1">&#39;bitscore&#39;</span><span class="p">,</span> <span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]),</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Attribute to sort annotations before filtering (default bitscore)&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-strand&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Strand information is not used, if &#39;-t&#39; is used, sort GFF file with `sort -s -k 1,1`&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--iterations&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">IntRange</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
              <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Max number of iteration over which filter the overlaps&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--progress&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shows Progress Bar&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;input-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;output-file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">filter_overlaps</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">choose_func</span><span class="p">,</span> <span class="n">sort_attr</span><span class="p">,</span> <span class="n">no_strand</span><span class="p">,</span>
                    <span class="n">iterations</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>

    <span class="n">mgkit</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">config_log</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">choose_func</span> <span class="o">=</span> <span class="n">make_choose_func</span><span class="p">(</span><span class="n">choose_func</span><span class="p">)</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Writing to file (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Max number of iterations: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">iterations</span><span class="p">)</span>

    <span class="n">file_iterator</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">parse_gff</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">gff_type</span><span class="o">=</span><span class="n">gff</span><span class="o">.</span><span class="n">from_gff</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">no_strand</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Annotations strand will be ignored&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">group_key_func</span><span class="p">(</span><span class="n">a</span><span class="p">):</span> <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">seq_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">group_key_func</span><span class="p">(</span><span class="n">a</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">seq_id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">sorted</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input GFF is assumed sorted&quot;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">gff</span><span class="o">.</span><span class="n">group_annotations_sorted</span><span class="p">(</span><span class="n">file_iterator</span><span class="p">,</span>
                                               <span class="n">key_func</span><span class="o">=</span><span class="n">group_key_func</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">viewvalues</span><span class="p">(</span><span class="n">gff</span><span class="o">.</span><span class="n">group_annotations</span><span class="p">(</span><span class="n">file_iterator</span><span class="p">,</span>
                             <span class="n">key_func</span><span class="o">=</span><span class="n">group_key_func</span><span class="p">))</span>

    <span class="n">choose_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">filter_gff</span><span class="o">.</span><span class="n">choose_annotation</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
        <span class="n">choose_func</span><span class="o">=</span><span class="n">choose_func</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">annotations</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">prev_filtered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">num_iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_gff</span><span class="o">.</span><span class="n">filter_annotations</span><span class="p">(</span>
                <span class="n">prev_filtered</span><span class="p">,</span>
                <span class="n">choose_func</span><span class="o">=</span><span class="n">choose_func</span><span class="p">,</span>
                <span class="n">sort_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">sort_attr</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># if the number of annotations is the same, there&#39;s no need to</span>
            <span class="c1"># keep going</span>
            <span class="k">if</span> <span class="n">prev_filtered</span> <span class="o">==</span> <span class="n">filtered</span><span class="p">:</span>
                <span class="c1"># LOG.debug(&quot;Number of iterations %d&quot;, num_iteration + 1)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_filtered</span> <span class="o">=</span> <span class="n">filtered</span>

        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">:</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013-2020, Francesco Rubino

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>